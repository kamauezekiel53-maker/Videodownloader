<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>YouTube Downloader — EK-Tech | Ezekiel Kamau</title>
  <style>
    :root{
      --bg:#0f1720;
      --card:#0b1220;
      --muted:#9aa6b2;
      --accent:#06b6d4;
      --accent-2:#7c3aed;
      --glass: rgba(255,255,255,0.04);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background: linear-gradient(180deg,var(--bg),#071026);
      color:#e6eef6;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      padding:28px;
    }
    .wrap{max-width:980px;margin:0 auto}
    header{display:flex;align-items:center;justify-content:space-between;padding:18px 0}
    h1{font-size:20px;margin:0}
    .sub{color:var(--muted);font-size:13px}
    .search{
      display:flex;gap:8px;margin-top:18px;
    }
    input[type="search"]{
      flex:1;padding:12px 14px;border-radius:10px;border:1px solid rgba(255,255,255,0.06);
      background:var(--card);color:inherit;font-size:15px;
      outline: none;
    }
    button{
      background: linear-gradient(90deg,var(--accent),var(--accent-2));
      border:none;color:white;padding:10px 14px;border-radius:10px;font-weight:600;
      cursor:pointer;
    }
    .results{margin-top:20px;display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:12px}
    .card{background:var(--glass);padding:12px;border-radius:12px;display:flex;gap:12px;align-items:flex-start}
    .thumb{width:140px;height:80px;flex:0 0 140px;border-radius:8px;object-fit:cover;background:#08121b}
    .meta{flex:1}
    .title{font-size:15px;margin:0 0 6px 0}
    .meta .channel{color:var(--muted);font-size:13px;margin-bottom:8px}
    .actions{display:flex;gap:8px;margin-top:8px}
    .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:8px 10px;border-radius:8px;color:var(--muted);cursor:pointer}
    .note{font-size:13px;color:var(--muted);margin-top:16px}
    footer{margin-top:28px;color:var(--muted);font-size:13px;text-align:center}
    .loader{display:inline-block;width:18px;height:18px;border-radius:50%;border:3px solid rgba(255,255,255,0.08);border-top-color:var(--accent);animation:spin .9s linear infinite;vertical-align:middle}
    @keyframes spin {to{transform:rotate(360deg)}}
    .small{font-size:12px;color:var(--muted)}
    .error{color:#ff7b7b}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>YouTube Downloader — EK-Tech</h1>
        <div class="sub">Built for Ezekiel Kamau — Search, preview metadata, then download via your extraction backend.</div>
      </div>
      <div class="small">Frontend-only: searches use YouTube Data API (metadata only)</div>
    </header>

    <main>
      <div class="search" role="search" aria-label="YouTube search">
        <input id="q" type="search" placeholder="Search YouTube videos (e.g., lo-fi beats)" />
        <button id="searchBtn">Search</button>
      </div>

      <div id="status" class="note small">Enter a query and press Search. (Your Google API key is used only for metadata.)</div>

      <div id="results" class="results" aria-live="polite"></div>

      <div class="note">
        Important: This frontend <strong>does not</strong> attempt to download from Google. Downloads are performed by your backend endpoints:
        <code>/mp4?url=VIDEO_URL</code> and <code>/mp3?url=VIDEO_URL</code>.
      </div>
    </main>

    <footer>
      Developed for Ezekiel Kamau — keep your API key for metadata only. Backend should implement extraction (ytdl-core / yt-dlp) and enable CORS as needed.
    </footer>
  </div>

  <script>
    /**
     * CONFIGURATION
     * - Replace 'YOUR_YOUTUBE_API_KEY' with your YouTube Data API v3 key.
     * - This key must be used only for search and video metadata calls.
     *
     * BACKEND:
     * - /mp4?url=VIDEO_URL  -> returns JSON { download: "DIRECT_FILE_URL" } OR redirects/streams file
     * - /mp3?url=VIDEO_URL  -> streams an MP3 download (Content-Disposition) OR returns { download: "..."}
     *
     * SECURITY NOTE:
     * - Do NOT attempt to use the Google key to perform downloads.
     * - Keep your key restricted to HTTP referrers (your domain) and to the YouTube Data API.
     */
    const YT_API_KEY = 'AIzaSyBh5f3-YNrL9bI97vbQiCQQlXxVHo4Ju2A'; // <-- PLACE YOUR API KEY HERE (metadata/search ONLY)

    const resultsEl = document.getElementById('results');
    const statusEl = document.getElementById('status');
    const searchBtn = document.getElementById('searchBtn');
    const qInput = document.getElementById('q');

    function setStatus(html) { statusEl.innerHTML = html; }

    async function searchYouTube(q) {
      if (!YT_API_KEY) {
        setStatus('<span class="error">No YouTube API key configured. Set YT_API_KEY in the code.</span>');
        return [];
      }
      setStatus('<span class="small">Searching <span class="loader"></span></span>');
      const params = new URLSearchParams({
        part: 'snippet',
        q: q,
        type: 'video',
        maxResults: '12',
        key: YT_API_KEY
      });
      try {
        const resp = await fetch(`https://www.googleapis.com/youtube/v3/search?${params}`);
        if (!resp.ok) {
          const txt = await resp.text();
          setStatus('<span class="error">YouTube API error — check key, quotas, restrictions.</span>');
          console.error('YT API error', resp.status, txt);
          return [];
        }
        const data = await resp.json();
        if (!data.items) return [];
        // Map to a small result structure
        const items = data.items.map(item => ({
          id: item.id.videoId,
          title: item.snippet.title,
          channel: item.snippet.channelTitle,
          thumb: (item.snippet.thumbnails.medium || item.snippet.thumbnails.default).url,
          description: item.snippet.description
        }));
        setStatus(`Showing ${items.length} results for "<strong>${escapeHtml(q)}</strong>"`);
        return items;
      } catch (err) {
        console.error(err);
        setStatus('<span class="error">Network error while searching.</span>');
        return [];
      }
    }

    function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

    function renderResults(items) {
      resultsEl.innerHTML = '';
      if (!items.length) {
        resultsEl.innerHTML = '<div class="small">No results.</div>';
        return;
      }
      items.forEach(it => {
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <img class="thumb" src="${escapeHtml(it.thumb)}" alt="${escapeHtml(it.title)} thumbnail" />
          <div class="meta">
            <h3 class="title">${escapeHtml(it.title)}</h3>
            <div class="channel">${escapeHtml(it.channel)}</div>
            <div class="small">${escapeHtml(truncate(it.description, 150))}</div>
            <div class="actions">
              <button class="btn-ghost btn-details" data-id="${it.id}">Details</button>
              <button class="btn-ghost btn-mp4" data-id="${it.id}">Get MP4</button>
              <button class="btn-ghost btn-mp3" data-id="${it.id}">Get MP3</button>
              <a class="btn-ghost" href="https://www.youtube.com/watch?v=${it.id}" target="_blank" rel="noopener">Open YouTube</a>
            </div>
          </div>
        `;
        resultsEl.appendChild(card);
      });

      // Attach actions
      resultsEl.querySelectorAll('.btn-mp4').forEach(btn => {
        btn.addEventListener('click', onGetMp4);
      });
      resultsEl.querySelectorAll('.btn-mp3').forEach(btn => {
        btn.addEventListener('click', onGetMp3);
      });
      resultsEl.querySelectorAll('.btn-details').forEach(btn => {
        btn.addEventListener('click', e => {
          const id = e.currentTarget.dataset.id;
          alert('Video URL: https://www.youtube.com/watch?v=' + id + '\n\nUse this URL when calling your backend endpoints.');
        });
      });
    }

    function truncate(s, n){ if(!s)return ''; return s.length>n? s.slice(0,n-1)+'…':s; }

    async function onGetMp4(e) {
      const id = e.currentTarget.dataset.id;
      const videoUrl = `https://www.youtube.com/watch?v=${id}`;
      setStatus(`<span class="small">Requesting MP4 from backend for <strong>${escapeHtml(id)}</strong> <span class="loader"></span></span>`);
      try {
        // Expect JSON { download: "DIRECT_URL" } or the endpoint may stream/redirect
        const resp = await fetch(`/mp4?url=${encodeURIComponent(videoUrl)}`);
        if (!resp.ok) {
          const txt = await resp.text();
          setStatus(`<span class="error">Backend /mp4 error: ${resp.status}</span>`);
          console.error('Backend /mp4 error', resp.status, txt);
          return;
        }
        const contentType = resp.headers.get('Content-Type') || '';
        if (contentType.includes('application/json')) {
          const data = await resp.json();
          if (data.download) {
            // Trigger download via temporary anchor
            triggerDownload(data.download, `${id}.mp4`);
            setStatus('Download started (direct link provided by backend).');
          } else {
            setStatus('<span class="error">Backend responded but gave no download URL.</span>');
          }
        } else {
          // Backend might be streaming a file — create blob and download
          const blob = await resp.blob();
          const url = URL.createObjectURL(blob);
          triggerDownload(url, `${id}.mp4`);
          URL.revokeObjectURL(url);
          setStatus('MP4 streamed from backend and downloaded.');
        }
      } catch (err) {
        console.error(err);
        setStatus('<span class="error">Network error contacting /mp4 backend.</span>');
      }
    }

    async function onGetMp3(e) {
      const id = e.currentTarget.dataset.id;
      const videoUrl = `https://www.youtube.com/watch?v=${id}`;
      setStatus(`<span class="small">Requesting MP3 from backend for <strong>${escapeHtml(id)}</strong> <span class="loader"></span></span>`);
      try {
        // For MP3, many backends stream a file with Content-Disposition.
        // We'll attempt to open in a new tab/window so browser handles the stream (and downloads).
        const endpoint = `/mp3?url=${encodeURIComponent(videoUrl)}`;
        // Use window.open to allow streaming/download behavior.
        window.open(endpoint, '_blank', 'noopener');
        setStatus('Opened backend /mp3 in a new tab — if backend streams MP3 it should download or play.');
      } catch (err) {
        console.error(err);
        setStatus('<span class="error">Error opening /mp3 endpoint.</span>');
      }
    }

    function triggerDownload(url, filename) {
      const a = document.createElement('a');
      a.href = url;
      a.download = filename || '';
      document.body.appendChild(a);
      a.click();
      a.remove();
    }

    // wire search
    searchBtn.addEventListener('click', async () => {
      const q = qInput.value.trim();
      if (!q) { setStatus('<span class="error">Please enter a search term.</span>'); return; }
      const items = await searchYouTube(q);
      renderResults(items);
    });
    qInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ searchBtn.click(); } });

    // initial demo text (optional)
    qInput.value = '';
  </script>
</body>
</html>